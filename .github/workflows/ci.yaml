name: cd pipeline
on:
    workflow_dispatch:

permissions:
    contents: read
    id-token: write

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Log in to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Docker Build Backend and push to docker hub
          working-directory: ./Application-code/Backend
          run: |
            docker build -t app-backend .
            docker tag app-backend:latest stefnie/app-backend:latest
            docker push stefnie/app-backend:latest
           
        - name: Docker Build Frontend and push to docker hub
          working-directory: ./Application-code/Frontend
          run: |
            docker build -t app-frontend .
            docker tag app-frontend:latest stefnie/app-frontend:latest
            docker push stefnie/app-frontend:latest
    
        - name: Configure AWS Credentials for OIDC
          uses: aws-actions/configure-aws-credentials@v4.1.0
          with:
            audience: sts.amazonaws.com
            aws-region: us-east-1
            role-to-assume: arn:aws:iam::902839103466:role/openid-role

        - name: SSH into EC2 instance
          uses: appleboy/ssh-action@v1
          with:
            host: ${{ secrets.EC2_HOST }}
            username: ${{ secrets.EC2_USERNAME }}
            key: ${{ secrets.EC2_PRIVATE_KEY }}
            script: |
              echo "Deploying application..."
              sudo su
              docker pull stefnie/app-backend:latest
              docker pull stefnie/app-frontend:latest

       